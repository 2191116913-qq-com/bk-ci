(window.webpackJsonp=window.webpackJsonp||[]).push([["pipelinesEntry~pipelinesHistory"],{ZzwQ:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=l(i("OBCi")),r=l(i("tZmG")),s=l(i("06Hw")),p=l(i("YYXh")),a=l(i("Kz1y")),o=i("WIBD"),c=i("ygAv"),u=i("Vgl9");function l(e){return e&&e.__esModule?e:{default:e}}t.default={computed:(0,a.default)({},(0,o.mapGetters)({pipelineList:"pipelines/getPipelineList",tagGroupList:"pipelines/getTagGroupList",curPipeline:"pipelines/getCurPipeline",isEditing:"atom/isEditing",checkPipelineInvalid:"atom/checkPipelineInvalid"}),(0,o.mapState)("pipelines",["pipelineSetting","pipelineAuthority"]),(0,o.mapState)("atom",["pipeline","executeStatus","saveStatus"]),{projectId:function(){return this.$route.params.projectId},pipelineId:function(){return this.$route.params.pipelineId},longProjectId:function(){return this.$store.state.curProject.project_id||""},isTemplatePipeline:function(){return this.curPipeline&&this.curPipeline.instanceFromTemplate}}),methods:(0,a.default)({},(0,o.mapActions)("pipelines",{requestPipelinesList:"requestPipelinesList",requestExecPipeline:"requestExecPipeline",requestToggleCollect:"requestToggleCollect",removePipeline:"deletePipeline",copyPipelineAction:"copyPipeline",updatePipelineSetting:"updatePipelineSetting"}),(0,o.mapActions)("atom",["setPipelineEditing","setExecuteStatus","setSaveStatus"]),{fetchPipelineList:function(){var e=this;return(0,p.default)(s.default.mark((function t(){var i,n,r,p;return s.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,i=e.pipelineId,n=e.requestPipelinesList,r=e.projectId,t.next=4,n({projectId:r,tag:"pipelines",page:1,pageSize:-1});case 4:p=t.sent,e.$store.commit("pipelines/updatePipelineList",p.records),e.$nextTick((function(){e.updateCurPipelineId(i)})),t.next=12;break;case 9:t.prev=9,t.t0=t.catch(0),e.$showTips({message:t.t0.message||t.t0,theme:"error"});case 12:case"end":return t.stop()}}),t,e,[[0,9]])})))()},togglePipelineCollect:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return(0,p.default)(s.default.mark((function n(){return s.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,t.requestToggleCollect({projectId:t.projectId,pipelineId:e,isCollect:i});case 3:t.$showTips({message:i?"收藏成功":"取消收藏成功",theme:"success"}),t.fetchPipelineList(),n.next=10;break;case 7:n.prev=7,n.t0=n.catch(0),t.$showTips({message:n.t0.message||n.t0,theme:"error"});case 10:case"end":return n.stop()}}),n,t,[[0,7]])})))()},terminatePipeline:function(e){var t=this;return(0,p.default)(s.default.mark((function i(){var n,r,p,a;return s.default.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if(n=t.$store,r=t.projectId,p=t.pipelineList.find((function(t){return t.pipelineId===e})),(a=p.feConfig).buttonAllow.terminatePipeline){i.next=5;break}return i.abrupt("return");case 5:return a.buttonAllow.terminatePipeline=!1,i.prev=6,i.next=9,n.dispatch("pipelines/requestTerminatePipeline",{projectId:r,pipelineId:e,buildId:a.buildId||p.latestBuildId});case 9:t.updatePipelineValueById(e,{isRunning:!1,status:"known_error"}),i.next=15;break;case 12:i.prev=12,i.t0=i.catch(6),403===i.t0.code?t.setPermissionConfig("流水线："+p.pipelineName,"执行",p.pipelineId):t.$showTips({message:i.t0.message||i.t0,theme:"error"});case 15:return i.prev=15,a.buttonAllow.terminatePipeline=!0,i.finish(15);case 18:case"end":return i.stop()}}),i,t,[[6,12,15,18]])})))()},delete:function(e){var t=this,i=e.pipelineId,n=e.pipelineName;return(0,p.default)(s.default.mark((function e(){var r,p,a;return s.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=void 0,p=void 0,a="删除【"+n+"】流水线",e.prev=2,e.next=5,(0,c.navConfirm)({title:"确认删除",content:a});case 5:return e.next=7,t.removePipeline({projectId:t.projectId,pipelineId:i});case 7:t.$router.push({name:"pipelinesList"}),r="删除流水线成功",p="success",e.next=15;break;case 12:e.prev=12,e.t0=e.catch(2),403===e.t0.code?t.setPermissionConfig("流水线："+n,"删除",t.projectId,i):(r=e.t0.message||e.t0,p="error");case 15:return e.prev=15,r&&t.$showTips({message:r,theme:p}),e.finish(15);case 18:case"end":return e.stop()}}),e,t,[[2,12,15,18]])})))()},copy:function(e,t){var i=this;return(0,p.default)(s.default.mark((function n(){var r,p,o,c,u,l;return s.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(r=i.projectId,p=i.copyPipelineAction,o=i.pipelineList,c="",u="",l=o.find((function(e){return e.pipelineId===t})),n.prev=4,e.name){n.next=7;break}throw new Error("流水线名称不能为空");case 7:return n.next=9,p({projectId:r,pipelineId:t,args:(0,a.default)({},e,{group:l.group,hasCollect:!1})});case 9:c="复制成功",u="success",i.$nextTick((function(){i.fetchPipelineList()})),n.next=17;break;case 14:n.prev=14,n.t0=n.catch(4),403===n.t0.code?i.setPermissionConfig("流水线："+l.pipelineName,"编辑",r,l.pipelineId):(c=n.t0.message||n.t0,u="error");case 17:return n.prev=17,c&&i.$showTips({message:c,theme:u}),n.finish(17);case 20:case"end":return n.stop()}}),n,i,[[4,14,17,20]])})))()},rename:function(e,t,i){var n=e.name,a=this;return(0,p.default)(s.default.mark((function e(){var p,o;return s.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(p="",o="",e.prev=2,n){e.next=5;break}throw new Error("流水线名称不能为空");case 5:return e.next=7,a.$ajax.post("/"+u.PROCESS_API_URL_PREFIX+"/user/pipelines/"+t+"/"+i,{name:n});case 7:a.$nextTick((function(){a.fetchPipelineList(),a.pipelineSetting&&(0,r.default)(a.pipelineSetting).length&&a.updatePipelineSetting({container:a.pipelineSetting,param:{pipelineName:n}})})),p="修改流水线名称成功",o="success",e.next=15;break;case 12:e.prev=12,e.t0=e.catch(2),403===e.t0.code?a.setPermissionConfig("流水线："+a.curPipeline.pipelineName,"编辑",t,a.curPipeline.pipelineId):(p=e.t0.message||e.t0,o="error");case 15:return e.prev=15,p&&a.$showTips({message:p,theme:o}),e.finish(15);case 18:case"end":return e.stop()}}),e,a,[[2,12,15,18]])})))()},executePipeline:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return(0,p.default)(s.default.mark((function n(){var r,p,a,o,c,u,l;return s.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return r=void 0,p=void 0,a=t.projectId,o=t.pipelineId,c=t.requestExecPipeline,u=t.setExecuteStatus,n.prev=2,u(!0),n.next=6,c({projectId:a,params:e,pipelineId:o});case 6:(l=n.sent).id?(r="启动构建成功",p="success",i&&t.$router.push({name:"pipelinesDetail",params:{projectId:a,pipelineId:o,buildNo:l.id}})):(r="启动构建失败",p="error"),n.next=13;break;case 10:n.prev=10,n.t0=n.catch(2),403===n.t0.code?t.setPermissionConfig("流水线："+t.curPipeline.pipelineName,"执行",t.projectId,o):(r=n.t0.message||n.t0,p="error");case 13:return n.prev=13,u(!1),r&&t.$showTips({message:r,theme:p}),n.finish(13);case 17:case"end":return n.stop()}}),n,t,[[2,10,13,17]])})))()},savePipeline:function(){var e=this.checkPipelineInvalid,t=this.projectId,i=this.pipelineId,n=this.pipeline,r=e(n.stages),s=r.inValid,p=r.message;if(s)throw new Error(p);return this.$ajax.put("/"+u.PROCESS_API_URL_PREFIX+"/user/pipelines/"+t+"/"+i,n)},getPipelineSetting:function(){var e=this.pipelineSetting,t=this.projectId;return(0,a.default)({},e,{projectId:t})},savePipelineSetting:function(){var e=this.$route,t=this.getPipelineSetting(),i="templateSetting"===e.name?"/"+u.PROCESS_API_URL_PREFIX+"/user/templates/projects/"+this.projectId+"/templates/"+this.templateId+"/settings":"/"+u.PROCESS_API_URL_PREFIX+"/user/setting/save",n="templateSetting"===e.name?"put":"post";return this.$ajax[n](i,t)},saveSetting:function(){var e=this.getPipelineSetting(),t=this.projectId,i=this.pipelineId;return this.$ajax.post("/"+u.PROCESS_API_URL_PREFIX+"/user/pipelines/"+t+"/"+i+"/saveSetting",e)},retry:function(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return(0,p.default)(s.default.mark((function n(){var r,p,o;return s.default.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return r=void 0,p=void 0,n.prev=1,n.next=4,t.$store.dispatch("pipelines/requestRetryPipeline",(0,a.default)({},t.$route.params,{buildId:e}));case 4:(o=n.sent).id?(r="重试成功",p="success",i&&t.$router.replace({name:"pipelinesDetail",params:{projectId:t.projectId,pipelineId:t.pipelineId,buildNo:o.id}}),t.$emit("update-table")):(r="重试失败",p="error"),n.next=17;break;case 8:if(n.prev=8,n.t0=n.catch(1),403!==n.t0.code){n.next=15;break}return t.setPermissionConfig("流水线："+t.curPipeline.pipelineName,"执行",t.$route.params.projectId,t.$route.params.pipelineId),n.abrupt("return");case 15:r=n.t0.message||n.t0,p="error";case 17:return n.prev=17,r&&t.$showTips({message:r,theme:p}),n.finish(17);case 20:case"end":return n.stop()}}),n,t,[[1,8,17,20]])})))()},savePipelineAndSetting:function(){var e=this;return(0,p.default)(s.default.mark((function t(){var i,n,r,p,o,c,l,d;return s.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(i=e.pipelineSetting,n=e.checkPipelineInvalid,r=e.$route,p=e.pipeline,o=n(p.stages),c=o.inValid,l=o.message,!c){t.next=4;break}throw new Error(l);case 4:return d=(0,a.default)({},i,{projectId:r.params.projectId}),t.abrupt("return",e.$ajax.post("/"+u.PROCESS_API_URL_PREFIX+"/user/pipelines/"+r.params.projectId+"/"+r.params.pipelineId+"/saveAll",{model:(0,a.default)({},p,{name:d.pipelineName,desc:d.desc}),setting:d}));case 6:case"end":return t.stop()}}),t,e)})))()},save:function(){var e=this;return(0,p.default)(s.default.mark((function t(){var i;return s.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,e.setSaveStatus(!0),i=e.isTemplatePipeline?e.saveSetting:e.savePipelineAndSetting,t.next=5,n.default.all([i()]);case 5:if(!t.sent.some((function(e){return 403===e.code}))){t.next=9;break}return e.setPermissionConfig("流水线："+e.pipeline.name,"编辑",e.$route.params.projectId,e.$route.params.pipelineId),t.abrupt("return",!1);case 9:return e.setPipelineEditing(!1),e.$showTips({message:"流水线保存成功",theme:"success"}),e.fetchPipelineList(),t.abrupt("return",!0);case 15:return t.prev=15,t.t0=t.catch(0),403===t.t0.code?e.setPermissionConfig("流水线："+e.pipeline.name,"编辑",e.$route.params.projectId,e.$route.params.pipelineId):e.$showTips({message:t.t0.message,theme:"error"}),t.abrupt("return",!1);case 19:return t.prev=19,e.setSaveStatus(!1),t.finish(19);case 22:case"end":return t.stop()}}),t,e,[[0,15,19,22]])})))()},saveAsPipelineTemplate:function(e,t,i){var n=this,r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return(0,p.default)(s.default.mark((function p(){return s.default.wrap((function(s){for(;;)switch(s.prev=s.next){case 0:if(s.prev=0,i){s.next=3;break}throw new Error("模板名称不能为空");case 3:return s.next=5,n.$ajax.post(u.PROCESS_API_URL_PREFIX+"/user/templates/projects/"+e+"/templates/saveAsTemplate",{pipelineId:t,templateName:i,copySetting:r});case 5:n.$showTips({message:"另存为模板成功",theme:"success"}),s.next=11;break;case 8:s.prev=8,s.t0=s.catch(0),403===s.t0.code?n.setPermissionConfig("流水线："+n.pipeline.name,"编辑",n.$route.params.projectId,n.$route.params.pipelineId):n.$showTips({message:s.t0.message,theme:"error"});case 11:case"end":return s.stop()}}),p,n,[[0,8]])})))()},setPermissionConfig:function(e,t,i,n){this.$showAskPermissionDialog({noPermissionList:[{resource:e,option:t}],applyPermissionUrl:PERM_URL_PIRFIX+"/backend/api/perm/apply/subsystem/?client_id=pipeline&project_code="+i+"&service_code=pipeline&"+("执行"===t?"role_executor":"role_manager")+"=pipeline:"+n})},updateCurPipelineId:function(e){for(var t=0;t<this.pipelineList.length;t++){var i=this.pipelineList[t];if(i.pipelineId===e)return void this.$store.commit("pipelines/updateCurPipeline",i)}},updateCurPipelineByKeyValue:function(e,t){this.$store.commit("pipelines/updateCurPipelineByKeyValue",{key:e,value:t})},changeProject:function(){this.$toggleProjectMenu(!0)},goToApplyPerm:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"role_viewer",t=PERM_URL_PIRFIX+"/backend/api/perm/apply/subsystem/?client_id=pipeline&project_code="+this.$route.params.projectId+"&service_code=pipeline&"+e+"=pipeline:"+this.$route.params.pipelineId;window.open(t,"_blank")}})}}}]);