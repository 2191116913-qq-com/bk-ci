(window.webpackJsonp=window.webpackJsonp||[]).push([["createEnv"],{"3iL7":function(e,t,s){"use strict";var n=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"environment-create"},[s("div",{staticClass:"env-header"},[s("div",{staticClass:"title"},[s("i",{staticClass:"bk-icon icon-arrows-left",on:{click:e.toEnvList}}),e._v(" "),s("span",{staticClass:"header-text"},[e._v("新建环境")])])]),e._v(" "),s("section",{directives:[{name:"bkloading",rawName:"v-bkloading",value:{isLoading:e.loading.isLoading,title:e.loading.title},expression:"{\n            isLoading: loading.isLoading,\n            title: loading.title\n        }"}],staticClass:"sub-view-port"},[e.hasPermission?e._e():s("empty-tips",{attrs:{title:e.emptyTipsConfig.title,desc:e.emptyTipsConfig.desc,btns:e.emptyTipsConfig.btns}}),e._v(" "),e.hasPermission&&!e.loading.isLoading?s("bk-form",{staticClass:"create-env-form",attrs:{"label-width":100,model:e.createEnvForm}},[s("devops-form-item",{attrs:{label:"名称",required:!0,property:"name","is-error":e.errors.has("env_name"),"error-msg":e.errors.first("env_name")}},[s("bk-input",{directives:[{name:"validate",rawName:"v-validate",value:"required",expression:"'required'"}],staticClass:"env-name-input",attrs:{name:"env_name",maxlength:"30",placeholder:"请输入"},model:{value:e.createEnvForm.name,callback:function(t){e.$set(e.createEnvForm,"name",t)},expression:"createEnvForm.name"}})],1),e._v(" "),s("bk-form-item",{attrs:{label:"环境描述",property:"desc"}},[s("bk-input",{staticClass:"env-desc-input",attrs:{placeholder:"请输入",type:"textarea",rows:3,maxlength:100},model:{value:e.createEnvForm.desc,callback:function(t){e.$set(e.createEnvForm,"desc",t)},expression:"createEnvForm.desc"}})],1),e._v(" "),s("bk-form-item",{staticClass:"env-type-item",attrs:{label:"环境类型",required:!0,property:"envType"}},[s("bk-radio-group",{model:{value:e.createEnvForm.envType,callback:function(t){e.$set(e.createEnvForm,"envType",t)},expression:"createEnvForm.envType"}},[s("bk-radio",{attrs:{value:"BUILD"}},[e._v("构建环境")])],1)],1),e._v(" "),s("bk-form-item",{attrs:{label:"节点来源",required:!0,property:"source"}},[s("div",{staticClass:"env-source-content"},[s("div",{staticClass:"source-type-radio"},[s("bk-radio-group",{model:{value:e.createEnvForm.source,callback:function(t){e.$set(e.createEnvForm,"source",t)},expression:"createEnvForm.source"}},[s("bk-radio",{attrs:{value:"EXISTING"}},[e._v("第三方构建机")])],1),e._v(" "),"EXISTING"===e.createEnvForm.source&&e.previewNodeList.length>0?s("span",{staticClass:"preview-node-btn",on:{click:e.toShowNodeList}},[e._v("选取节点")]):e._e()],1),e._v(" "),"EXISTING"===e.createEnvForm.source&&0===e.previewNodeList.length?s("div",{staticClass:"empty-node-selected"},[s("p",{staticClass:"empty-prompt"},[e._v("暂未选取节点，\n                            "),s("span",{staticClass:"show-node-dialog",on:{click:e.toShowNodeList}},[e._v("点击选取节点")])]),e._v(" "),e.errorHandler.nodeHashIds?s("div",{staticClass:"error-tips"},[e._v("节点不能为空")]):e._e()]):e._e(),e._v(" "),"EXISTING"===e.createEnvForm.source&&e.previewNodeList.length>0?s("div",{staticClass:"selected-node-Preview"},[s("div",{staticClass:"node-table-message"},[s("div",{staticClass:"table-node-head"},[s("div",{staticClass:"table-node-item node-item-ip"},[e._v("IP")]),e._v(" "),s("div",{staticClass:"table-node-item node-item-name"},[e._v("主机名")]),e._v(" "),s("div",{staticClass:"table-node-item node-item-type"},[e._v("节点类型")]),e._v(" "),s("div",{staticClass:"table-node-item node-item-status"},[e._v("节点状态")]),e._v(" "),s("div",{staticClass:"table-node-item node-item-agstatus"},[e._v("Agent状态")])]),e._v(" "),s("div",{staticClass:"table-node-body"},e._l(e.previewNodeList,(function(t,n){return s("div",{key:n,staticClass:"table-node-row"},[s("div",{staticClass:"table-node-item node-item-ip"},[s("span",{staticClass:"node-ip"},[e._v(e._s(t.ip))])]),e._v(" "),s("div",{staticClass:"table-node-item node-item-name"},[s("span",{staticClass:"node-name"},[e._v(e._s(t.name))])]),e._v(" "),s("div",{staticClass:"table-node-item node-item-type"},[s("span",{staticClass:"node-type"},[e._v(e._s(e.getNodeTypeMap[t.nodeType]))])]),e._v(" "),s("div",{staticClass:"table-node-item node-item-status"},[s("span",{staticClass:"node-name"},[e._v(e._s(t.nodeStatus))])]),e._v(" "),s("div",{staticClass:"table-node-item node-item-agstatus"},["BCSVM"===t.nodeType?s("span",{staticClass:"node-status",class:t.agentStatus?"normal-status-node":"refresh-status-node"},[e._v(e._s(t.agentStatus?"正常":"刷新中")+"\n                                        ")]):s("span",{staticClass:"node-status",class:t.agentStatus?"normal-status-node":"abnormal-status-node"},[e._v(e._s(t.agentStatus?"正常":"刷新中")+"\n                                        ")])])])})),0)])]):e._e()])]),e._v(" "),s("bk-form-item",[s("bk-button",{attrs:{theme:"primary",title:"提交"},on:{click:function(t){return t.stopPropagation(),t.preventDefault(),e.submit(t)}}},[e._v("提交")]),e._v(" "),s("bk-button",{attrs:{theme:"default",title:"取消"},on:{click:e.toEnvList}},[e._v("取消")])],1)],1):e._e()],1),e._v(" "),s("node-select",{attrs:{"node-select-conf":e.nodeSelectConf,"search-info":e.searchInfo,"cur-user-info":e.curUserInfo,"change-created-user":e.changeCreatedUser,"row-list":e.nodeList,"select-handlerc-conf":e.selectHandlercConf,"toggle-all-select":e.toggleAllSelect,loading:e.nodeDialogLoading,"confirm-fn":e.confirmFn,"cancel-fn":e.cancelFn,query:e.query}})],1)},i=[];n._withStripped=!0,s.d(t,"a",(function(){return n})),s.d(t,"b",(function(){return i}))},"7dCc":function(e,t,s){},"80kE":function(e,t,s){"use strict";s.r(t);var n=s("Te0k"),i=s.n(n);for(var a in n)"default"!==a&&function(e){s.d(t,e,(function(){return n[e]}))}(a);t.default=i.a},BSkQ:function(e,t,s){"use strict";var n=s("7dCc");s.n(n).a},Ixaf:function(e,t,s){},MkV0:function(e,t,s){"use strict";var n=s("Ixaf");s.n(n).a},Te0k:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={props:{title:{type:String,default:""},desc:{type:String,default:""},btns:{type:Array,default:function(){return[]}}}}},WAkQ:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n,i=l(s("06Hw")),a=l(s("YYXh")),r=l(s("Kz1y")),o=s("WIBD"),c=l(s("2yte")),d=l(s("wm1E"));function l(e){return e&&e.__esModule?e:{default:e}}t.default={components:{"empty-tips":d.default,nodeSelect:c.default},data:function(){return{cacheNodeSource:"EXISTING",hasPermission:!0,nodeList:[],buildNodeList:[],devNodeList:[],previewNodeList:[],errorHandler:{clusterId:!1,instanceCount:!1,nodeHashIds:!1,exceedCount:!1},loading:{isLoading:!1,title:"数据加载中，请稍候"},nodeDialogLoading:{isLoading:!1,title:""},selectHandlercConf:{curTotalCount:0,curDisplayCount:0,selectedNodeCount:0,allNodeSelected:!1,searchEmpty:!1},nodeSelectConf:{isShow:!1,quickClose:!1,unselected:!0,importText:"导入"},searchInfo:{search:""},createEnvForm:{name:"",desc:"",envType:"BUILD",source:"EXISTING",bcsVmParam:{clusterId:"",vmModelId:"",imageId:"",instanceCount:0,validity:1}},rules:{name:[{required:!0,message:"必填项",trigger:"blur"}]},emptyTipsConfig:{title:"没有权限",desc:"你在该项目【环境管理】下没有【创建】权限，请切换项目访问或申请",btns:[{type:"primary",size:"normal",handler:this.changeProject,text:"切换项目"},{type:"success",size:"normal",handler:this.goToApplyPerm,text:"去申请权限"}]}}},computed:(0,r.default)({},(0,o.mapGetters)("environment",["getNodeTypeMap","getNodeStatusMap"]),{projectId:function(){return this.$route.params.projectId},curUserInfo:function(){return window.userInfo}}),watch:{projectId:(n=(0,a.default)(i.default.mark((function e(t){return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.$router.push({name:"envList"});case 1:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)}),nodeList:{deep:!0,handler:function(e){var t=0,s=this.nodeList.some((function(e){return!0===e.isChecked}));this.nodeSelectConf.unselected=!s,this.nodeList.filter((function(e){e.isChecked&&t++})),this.selectHandlercConf.selectedNodeCount=t,this.decideToggle()}},"createEnvForm.envType":function(e){"BUILD"===e?(this.createEnvForm.source="EXISTING",this.previewNodeList=this.buildNodeList):(this.previewNodeList=this.devNodeList,this.createEnvForm.source=this.cacheNodeSource)},"createEnvForm.source":function(e){"BUILD"!==this.createEnvForm.envType&&(this.cacheNodeSource=e)}},created:function(){var e=this;return(0,a.default)(i.default.mark((function t(){return i.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.requestPermission();case 2:case"end":return t.stop()}}),t,e)})))()},methods:{toEnvList:function(){this.$router.push({name:"envList"})},changeProject:function(){this.iframeUtil.toggleProjectMenu(!0)},goToApplyPerm:function(){var e="/backend/api/perm/apply/subsystem/?client_id=environment&project_code="+this.projectId+"&service_code=environment&role_creator=environment";window.open(e,"_blank")},decideToggle:function(){var e=0,t=0;this.nodeList.forEach((function(s){s.isDisplay&&(e++,s.isChecked&&t++)})),this.selectHandlercConf.curDisplayCount=e,this.selectHandlercConf.allNodeSelected=e===t},toggleAllSelect:function(e){this.selectHandlercConf.allNodeSelected=e,this.selectHandlercConf.allNodeSelected?this.nodeList.forEach((function(e){e.isDisplay&&(e.isChecked=!0)})):this.nodeList.forEach((function(e){e.isDisplay&&(e.isChecked=!1)}))},query:function(e){var t=this;if(e.length){e.filter((function(e){return e&&e.length})),this.nodeList.forEach((function(s){var n=s.ip;if("BUILD"===t.createEnvForm.envType)for(var i=0;i<e.length;i++){if(e[i]&&n.indexOf(e[i])>-1&&"THIRDPARTY"===s.nodeType&&s.canUse){s.isDisplay=!0;break}s.isDisplay=!1}else for(var a=0;a<e.length;a++){if(e[a]&&n.indexOf(e[a])>-1&&"THIRDPARTY"!==s.nodeType&&s.canUse){s.isDisplay=!0;break}s.isDisplay=!1}}));var s=this.nodeList.some((function(e){return e.isDisplay}));this.selectHandlercConf.searchEmpty=!s}else this.selectHandlercConf.searchEmpty=!1,"BUILD"===this.createEnvForm.envType?this.nodeList.forEach((function(e){"THIRDPARTY"===e.nodeType&&e.canUse&&(e.isDisplay=!0)})):this.nodeList.forEach((function(e){"THIRDPARTY"!==e.nodeType&&e.canUse&&(e.isDisplay=!0)}));this.decideToggle()},checkIsEixt:function(e,t){for(var s=void 0,n=0;n<this.previewNodeList.length;n++)if("BUILD"===t){if(this.buildNodeList[n].nodeHashId===e){s=!0;break}}else if(this.devNodeList[n].nodeHashId===e){s=!0;break}return s},confirmFn:function(){var e=this,t=this.createEnvForm.envType;"BUILD"===t?(this.nodeList.forEach((function(s){if(s.isChecked&&!e.checkIsEixt(s.nodeHashId,t)&&"THIRDPARTY"===s.nodeType&&e.buildNodeList.push(s),!s.isChecked&&e.checkIsEixt(s.nodeHashId,t)&&"THIRDPARTY"===s.nodeType)for(var n=e.buildNodeList.length-1;n>=0;n--)e.buildNodeList[n].nodeHashId===s.nodeHashId&&e.buildNodeList.splice(n,1)})),this.previewNodeList=this.buildNodeList):(this.nodeList.forEach((function(s){if(s.isChecked&&!e.checkIsEixt(s.nodeHashId,t)&&"THIRDPARTY"!==s.nodeType&&e.devNodeList.push(s),!s.isChecked&&e.checkIsEixt(s.nodeHashId,t)&&"THIRDPARTY"!==s.nodeType)for(var n=e.devNodeList.length-1;n>=0;n--)e.devNodeList[n].nodeHashId===s.nodeHashId&&e.devNodeList.splice(n,1)})),this.previewNodeList=this.devNodeList),this.nodeSelectConf.isShow=!1},cancelFn:function(){this.nodeSelectConf.isShow=!1,this.selectHandlercConf.searchEmpty=!1},toShowNodeList:function(){this.searchInfo={search:""},this.nodeSelectConf.isShow=!0,this.requestNodeList()},validate:function(){var e=0;return this.previewNodeList.length||(this.errorHandler.nodeHashIds=!0,e++),!(e>0)},submit:function(){var e,t=this;if("CREATE"===this.createEnvForm.source){this.$bkMessage({message:"请选择节点来源",theme:"warning"})}else{var s=this.validate();this.$validator.validateAll().then((e=(0,a.default)(i.default.mark((function e(n){var a,r,o,c;return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!s||!n){e.next=21;break}return a=void 0,r=void 0,o={name:t.createEnvForm.name.trim(),desc:t.createEnvForm.desc,envType:t.createEnvForm.envType,source:t.createEnvForm.source,envVars:[]},"CREATE"===t.createEnvForm.source?o.bcsVmParam=t.createEnvForm.bcsVmParam:(c=[],t.previewNodeList.forEach((function(e){c.push(e.nodeHashId)})),o.nodeHashIds=c),t.loading.isLoading=!0,e.prev=5,e.next=8,t.$store.dispatch("environment/createNewEnv",{projectId:t.projectId,params:o});case 8:a="新增成功",r="success",e.next=16;break;case 12:e.prev=12,e.t0=e.catch(5),a=e.t0.message?e.t0.message:e.t0,r="error";case 16:return e.prev=16,t.$bkMessage({message:a,theme:r}),t.loading.isLoading=!1,"success"===r&&t.$router.push({name:"envList"}),e.finish(16);case 21:case"end":return e.stop()}}),e,t,[[5,12,16,21]])}))),function(t){return e.apply(this,arguments)}))}},requestPermission:function(){var e=this;return(0,a.default)(i.default.mark((function t(){var s,n;return i.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.loading.isLoading=!0,t.prev=1,t.next=4,e.$store.dispatch("environment/requestPermission",{projectId:e.projectId});case 4:s=t.sent,e.hasPermission=s,t.next=13;break;case 8:t.prev=8,t.t0=t.catch(1),n=t.t0.message?t.t0.message:t.t0,"error",e.$bkMessage({message:n,theme:"error"});case 13:return t.prev=13,setTimeout((function(){e.loading.isLoading=!1}),1e3),t.finish(13);case 16:case"end":return t.stop()}}),t,e,[[1,8,13,16]])})))()},requestNodeList:function(){var e=this;return(0,a.default)(i.default.mark((function t(){var s,n,a,r;return i.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.nodeDialogLoading.isLoading=!0,t.prev=1,t.next=4,e.$store.dispatch("environment/requestNodeList",{projectId:e.projectId});case 4:s=t.sent,e.nodeList.splice(0,e.nodeList.length),s.map((function(t){t.isChecked=!1,"BUILD"===e.createEnvForm.envType?"THIRDPARTY"===t.nodeType&&t.canUse?t.isDisplay=!0:t.isDisplay=!1:"THIRDPARTY"!==t.nodeType&&t.canUse?t.isDisplay=!0:t.isDisplay=!1,e.nodeList.push(t),e.previewNodeList.filter((function(t){e.nodeList.filter((function(e){t.nodeHashId===e.nodeHashId&&(e.isChecked=!0)}))}))})),n=0,e.nodeList.forEach((function(e){e.isDisplay&&n++})),e.selectHandlercConf.curTotalCount=n,a=e.nodeList.some((function(e){return e.isDisplay})),e.selectHandlercConf.searchEmpty=!a,t.next=19;break;case 14:t.prev=14,t.t0=t.catch(1),r=t.t0.message?t.t0.message:t.t0,"error",e.$bkMessage({message:r,theme:"error"});case 19:return t.prev=19,e.nodeDialogLoading.isLoading=!1,t.finish(19);case 22:case"end":return t.stop()}}),t,e,[[1,14,19,22]])})))()},changeCreatedUser:function(e){var t=this;return(0,a.default)(i.default.mark((function s(){var n,r;return i.default.wrap((function(s){for(;;)switch(s.prev=s.next){case 0:n=t.$createElement,r=n("p",{style:{textAlign:"center"}},"是否修改主机责任人为当前用户？"),t.$bkInfo({title:"修改导入人",subHeader:r,confirmFn:function(){var s=(0,a.default)(i.default.mark((function s(){var n,a,r,o;return i.default.wrap((function(s){for(;;)switch(s.prev=s.next){case 0:return n=void 0,a=void 0,r={},s.prev=2,s.next=5,t.$store.dispatch("environment/changeCreatedUser",{projectId:t.projectId,nodeHashId:e,params:r});case 5:n="修改成功",a="success",s.next=14;break;case 9:s.prev=9,s.t0=s.catch(2),o=s.t0.message?s.t0.message:s.t0,"error",t.$bkMessage({message:o,theme:"error"});case 14:return s.prev=14,t.$bkMessage({message:n,theme:a}),t.requestNodeList(),s.finish(14);case 18:case"end":return s.stop()}}),s,t,[[2,9,14,18]])})));return function(){return s.apply(this,arguments)}}()});case 3:case"end":return s.stop()}}),s,t)})))()}}}},k2vY:function(e,t,s){"use strict";s.r(t);var n=s("3iL7"),i=s("px3r");for(var a in i)"default"!==a&&function(e){s.d(t,e,(function(){return i[e]}))}(a);s("BSkQ");var r=s("psIG"),o=Object(r.a)(i.default,n.a,n.b,!1,null,null,null);o.options.__file="src/views/create_env.vue",t.default=o.exports},neEv:function(e,t,s){"use strict";var n=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("section",{staticClass:"devops-empty-tips"},[s("h2",{staticClass:"title"},[e._v(e._s(e.title))]),e._v(" "),s("p",{staticClass:"desc"},[e._v(e._s(e.desc))]),e._v(" "),s("p",{staticClass:"btns-row"},[e._t("btns",e._l(e.btns,(function(t,n){return s("button",{key:n,staticClass:"bk-button",class:["bk-"+t.type,"bk-button-"+t.size],on:{click:t.handler}},[e._v("\n                "+e._s(t.text)+"\n            ")])})))],2)])},i=[];n._withStripped=!0,s.d(t,"a",(function(){return n})),s.d(t,"b",(function(){return i}))},px3r:function(e,t,s){"use strict";s.r(t);var n=s("WAkQ"),i=s.n(n);for(var a in n)"default"!==a&&function(e){s.d(t,e,(function(){return n[e]}))}(a);t.default=i.a},wm1E:function(e,t,s){"use strict";s.r(t);var n=s("neEv"),i=s("80kE");for(var a in i)"default"!==a&&function(e){s.d(t,e,(function(){return i[e]}))}(a);s("MkV0");var r=s("psIG"),o=Object(r.a)(i.default,n.a,n.b,!1,null,null,null);o.options.__file="src/components/devops/emptyTips.vue",t.default=o.exports}}]);